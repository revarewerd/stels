package ru.sosgps.wayrecall.avlprotocols.navtelecom

import java.io.{OutputStream, InputStream}
import java.net.Socket

import com.google.common.base.Charsets
import io.netty.buffer.Unpooled
import io.netty.channel.nio.NioEventLoopGroup
import org.junit._
import ru.sosgps.wayrecall.testutils.TalkTestSetup
import ru.sosgps.wayrecall.utils.ScalaNettyUtils
import ScalaNettyUtils.ByteBufOps
import ru.sosgps.wayrecall.packreceiver.DummyPackSaver
import ru.sosgps.wayrecall.packreceiver.netty.NavTelecomNettyServer
import ru.sosgps.wayrecall.utils.io.Utils

/**
 * Created by nickl on 01.06.14.
 */
class ServerTest extends grizzled.slf4j.Logging with TalkTestSetup {

  val serverPort: Int = ServerTest.NAV_TEST_PORT

  import talk._

  @Test
  def testNCTB() {

    send("404e5443010000000000000013004c472a3e533a383638323034303034323131323633")

    expect("404e544300000000010000000300455e2a3c53")

    send("404e544301000000000000007200244e2a3e540674110000c1110f391015030ecc046300803700760e02000a000a00000000000000000000000000ffffff00faff00faff00faff00faff00faff00faff00faff15808080ffffffffffff010f231715030ea323fe01819b56010000000000000000bd00a444ec420000000003000000")
    expect("404e54430000000001000000070027382a3c5474110000")
    send("40 4e 54 43 01 00 00 00 00 00 00 00 00 00 00 18")

    val A = """40 4e 54 43 01 00 00 00 00 00 00 00 7c 03 85 e2
     2a 3e 41 08 06 48 11 00 00 00 15 0f 23 17 15 03 
     0e cc 04 63 00 00 24 00 1e 0d 02 00 00 00 00 00 
     00 00 00 00 00 00 00 00 00 00 00 00 ff ff ff 00 
     fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa 
     ff 00 fa ff e9 80 80 80 ff ff ff ff ff ff 00 0f 
     23 17 15 03 0e a3 23 fe 01 81 9b 56 01 00 00 00 
     00 00 00 00 00 bd 00 a4 44 ec 42 00 00 00 00 00 
     00 00 00 06 49 11 00 00 01 17 0f 23 18 15 03 0e 
     cc 04 63 00 00 24 00 17 0d 02 00 01 00 01 00 00 
     00 00 00 00 00 00 00 00 00 00 00 ff ff ff 00 fa 
     ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 
     00 fa ff 1f 80 80 80 ff ff ff ff ff ff 01 0f 23 
     17 15 03 0e a3 23 fe 01 81 9b 56 01 00 00 00 00 
     00 00 00 00 bd 00 a4 44 ec 42 00 00 00 00 00 00 
     00 00 06 4a 11 00 00 00 15 0f 23 18 15 03 0e cc 
     04 63 00 00 24 00 1a 0d 02 00 00 00 00 00 00 00 
     00 00 00 00 00 00 00 00 00 00 ff ff ff 00 fa ff 
     00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 
     fa ff e9 80 80 80 ff ff ff ff ff ff 00 0f 23 17 
     15 03 0e a3 23 fe 01 81 9b 56 01 00 00 00 00 00 
     00 00 00 bd 00 a4 44 ec 42 00 00 00 00 00 00 00 
     00 06 4b 11 00 00 01 17 0f 23 19 15 03 0e cc 04 
     63 00 00 24 00 14 0d 02 00 01 00 01 00 00 00 00 
     00 00 00 00 00 00 00 00 00 ff ff ff 00 fa ff 00 
     fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa 
     ff 1e 80 80 80 ff ff ff ff ff ff 01 0f 23 17 15 
     03 0e a3 23 fe 01 81 9b 56 01 00 00 00 00 00 00 
     00 00 bd 00 a4 44 ec 42 00 00 00 00 00 00 00 00 
     06 4c 11 00 00 00 15 0f 23 19 15 03 0e cc 06 63 
       00 00 24 00 8c 0c 01 00 00 00 00 00 00 00 00 00 
     00 00 00 00 00 00 00 00 ff ff ff 00 fa ff 00 fa 
     ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 
     e9 80 80 80 ff ff ff ff ff ff 00 0f 23 17 15 03 
     0e a3 23 fe 01 81 9b 56 01 00 00 00 00 00 00 00 
     00 bd 00 a4 44 ec 42 00 00 00 00 00 00 00 00 06 
     4d 11 00 00 02 18 0f 23 23 15 03 0e cc 06 63 00 
     00 12 00 a2 0c 02 00 05 00 04 00 00 00 00 00 00 
     00 00 00 00 00 00 00 ff ff ff 00 fa ff 00 fa ff 
     00 fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 0c 
     80 80 80 ff ff ff ff ff ff 00 0f 23 17 15 03 0e 
     a3 23 fe 01 81 9b 56 01 00 00 00 00 00 00 00 00 
     bd 00 a4 44 ec 42 00 00 00 00 00 00 00 00 06 4e 
       11 00 00 0e a2 0f 23 31 15 03 0e cc 06 63 00 00 
     12 00 bd 0c 02 00 07 00 07 00 00 00 00 00 00 00 
     00 00 00 00 00 00 ff ff ff 00 fa ff 00 fa ff 00 
     fa ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff 0d 80 
     80 80 ff ff ff ff ff ff 00 0f 23 17 15 03 0e a3 
     23 fe 01 81 9b 56 01 00 00 00 00 00 00 00 00 bd 
     00 a4 44 ec 42 00 00 00 00 00 00 00 00 06 4f 11 
     00 00 00 15 0f 23 31 15 03 0e cc 06 63 00 00 24 
       00 cc 0c 02 00 00 00 00 00 00 00 00 00 00 00 00 
     00 00 00 00 00 ff ff ff 00 fa ff 00 fa ff 00 fa 
     ff 00 fa ff 00 fa ff 00 fa ff 00 fa ff e9 80 80 
     80 ff ff ff ff ff ff 00 0f 23 17 15 03 0e a3 23 
     fe 01 81 9b 56 01 00 00 00 00 00 00 00 00 bd 00 
     a4 44 ec 42 00 00 00 00 00 00 00 00"""

    send(A)
    expect("404e5443000000000100000004005f432a3c4108")


    //    val resparr = Iterator.continually(socket.getInputStream.read()).takeWhile(-1 !=).map(_.toByte).toArray
    //
    //    debug("resparr=" + Utils.toHexString(resparr, ""))


  }

  @Test
  def flexTestC1() {
    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 fb f0" +
      "2a 3e 46 4c 45 58 b0 0a 0a 45 e1 ec 00 00 00 00 00 00 00")

    expect("40 4e 54 43 00 00 00 00 01 00 00 00 09 00 b1 a0" +
      "2a 3c 46 4c 45 58 b0 0a 0a")

    send("7e 43 ff ff 00 00 01 11 06 39 5a 54 01 06 39 5a" +
      "54 f1 c4 7d 4c 03 c5 9e 71 00 00 00 00 00 00 32")
    expect("7e 43 b9")

  }

  @Test
  def flexTestC2() {

    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 4d 46" +
      "2a 3e 53 3a 31 30 30 30 30 30 30 30 30 30 30 30 30 30 31")

    expect("40 4e 54 43 00 00 00 00 01 00 00 00 03 00 45 5e\n 2a 3c 53")

    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 f1 fa\n 2a 3e 46 4c 45 58 b0 0a 0a 45 e3 ec 00 00 08 00 00 00 00")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 09 00 b1 a0\n 2a 3c 46 4c 45 58 b0 0a 0a")

    send("7e 43 ff ff 00 00 01 11 10 40 5a 54 4f 01 10 40\n 5a 54 f1 c4 7d 4c 03 c5 9e 71 00 00 00 00 00 00 03 00 00 00 9c")
    expect("7e 43 b9")

    send("7e 43 ff ff 00 00 01 11 25 40 5a 54 45 1d 25 40 5a 54 3a 31 7d 4c de 23 9e 71 00 00 80 40 06 00 03 00 00 00 61")
    expect("7e 43 b9")

    send("7e 43 ff ff 00 00 01 11 39 40 5a 54 45 15 39 40 5a 54 5e b8 7c 4c 4b d3 9d 71 00 00 e0 40 07 00 03 00 00 00 e1")
    expect("7e 43 b9")

  }

  @Test
  def flexReal(): Unit ={
    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 49 42 2a 3e 53 3a 38 36 33 35 39 31 30 32 38 34 31 37 31 34 39 ")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 03 00 45 5e 2a 3c 53")
    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 00 0b 2a 3e 46 4c 45 58 b0 0a 0a 45 fb ff f0 0a 08 00 00 00 00")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 09 00 b1 a0 2a 3c 46 4c 45 58 b0 0a 0a")
    send("7e 41 08 00 00 00 00 00 15 80 43 6d 38 00 00 63 " +
      " 00 80 43 6d 38 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00" +
      " 00 00 00 49 b4 ca 09 00 00 00 00 00 00 01 00 00 " +
      "00 0a 10 81 43 6d 38 01 80 63 00 80 43 6d 38 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 45 b4 42 " +
      "09 00 00 01 00 00 00 03 00 00 00 01 11 82 43 6d " +
      "38 01 00 63 01 80 43 6d 38 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 43 b4 03 09 01 0e 01 00 00 " +
      "00 04 00 00 00 21 14 82 43 6d 38 01 00 63 01 80 " +
      "43 6d 38 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 43 b4 ff 08 01 0e 01 00 00 00 05 00 00 00 31 " +
      "14 82 43 6d 38 01 00 63 01 80 43 6d 38 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 43 b4 fb 08 01 " +
      "0e 01 00 00 00 06 00 00 00 41 14 82 43 6d 38 01 " +
      "00 63 01 80 43 6d 38 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 43 b4 fb 08 01 0e 01 00 00 00 07 " +
      "00 00 00 41 14 87 43 6d 38 01 00 63 01 80 43 6d " +
      "38 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 3c " +
      "b4 bc 05 01 0e 01 00 00 00 00 00 00 00 00 ff 59 " +
      "76 f0 54 00 2b 0f 0f 58 76 f0 54 82 5b fd 01 12 " +
      "be 56 01 49 05 00 00 00 00 00 00 00 00 00 00 00 " +
      "00 00 00 00 00 00 00 00 00 37 2f 86 0e 00 00 0a " +
      " 00 00 00 c6")
    expect("7e 41 08 57 ")
    send("40 4e 54 43 01 00 00 00 00 00 00 00 16 00 c9 c7 2a 3e 54 4d 4b 45 59 06 31 18 13 01 0f 3a 55 aa 55 f2 c6 05 00 00")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 07 00 58 47 2a 3c 54 4d 4b 45 59")

  }

  @Test
  def testT(): Unit = {

    send(Array[Byte](
      0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x4b, 0x40,
      0x2a, 0x3e, 0x53, 0x3a, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x37
    ))

    expect(Array[Byte](
      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x45, 0x5e,
      0x2a, 0x3c, 0x53
    ))
    send(Array(
      0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x13, 0x00, 0xfb, 0xf0, 0x2a, 0x3e, 0x46, 0x4c, 0x45, 0x58,
      0xb0, 0x0a, 0x0a, 0x45, 0xe1, 0xec, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00
    ).map(_.toByte))

    expect(Array(
      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x09, 0x00, 0xb1, 0xa0,
      0x2a, 0x3c, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a
    ).map(_.toByte))
    send(Array(
      0x7e, 0x54, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x21, 0x11, 0x82, 0x71, 0x5a, 0x54,
      0x11, 0x82, 0x71, 0x5a, 0x54, 0xf0, 0x4c, 0x7c, 0x4c, 0x4c, 0x31, 0x9e, 0x71, 0x00, 0x00, 0xe0,
      0x40, 0x02, 0x00, 0xc3
    ).map(_.toByte))

    expect(Array(
      0x7e, 0x54, 0x01, 0x00, 0x00, 0x00, 0x82
    ).map(_.toByte))
    send(Array(
      0x7e, 0x54, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x21, 0x11, 0x8b, 0x71, 0x5a, 0x54,
      0x11, 0x8b, 0x71, 0x5a, 0x54, 0xf0, 0x4c, 0x7c, 0x4c, 0x4c, 0x31, 0x9e, 0x71, 0x00, 0x00, 0xe0,
      0x40, 0x02, 0x00, 0x8d
    ).map(_.toByte))

    expect(Array[Byte](
      0x7e, 0x54, 0x02, 0x00, 0x00, 0x00, 0x1e
    ))
    send(Array(
      0x7e, 0x54, 0x04, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x01,
      0x11, 0x99, 0x71, 0x5a, 0x54, 0x11, 0x99, 0x71, 0x5a, 0x54, 0xf0,
      0x4c, 0x7c, 0x4c, 0x4c, 0x31, 0x9e, 0x71, 0x00, 0x00, 0xe0, 0x40,
      0x02, 0x00, 0x9b
    ).map(_.toByte))

    expect(Array[Byte](
      0x7e, 0x54, 0x04, 0x00, 0x00, 0x00, 0x17
    ))
  }

  @Test
  def testAT(): Unit = {


    send(Array[Byte](0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x4b, 0x40,
      0x2a, 0x3e, 0x53, 0x3a, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x37
    ))

    expect(Array[Byte](
      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x45, 0x5e,
      0x2a, 0x3c, 0x53
    ))

    send(Array(0x7f).map(_.toByte))

    send(Array(0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0xfb, 0xf0,
      0x2a, 0x3e, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a, 0x45, 0xe1, 0xec, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00
    ).map(_.toByte))

    expect(Array(
      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x09, 0x00, 0xb1, 0xa0,
      0x2a, 0x3c, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a
    ).map(_.toByte))

    send(Array(0x7f).map(_.toByte))
    send(Array(0x7f).map(_.toByte))

    send(Array(
      0x7e, 0x54, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x11, 0x8e, 0x59, 0x5a, 0x54,
      0x01, 0x8e, 0x59, 0x5a, 0x54, 0xf1, 0xc4, 0x7d, 0x4c, 0x03, 0xc5, 0x9e, 0x71, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x6d
    ).map(_.toByte))

    expect(Array(
      0x7e, 0x54, 0x03, 0x00, 0x00, 0x00, 0x85
    ).map(_.toByte))

    send(Array(
      0x7e, 0x41, 0x04, 0x05, 0x00, 0x00, 0x00, 0x01, 0x11, 0x9a, 0x59, 0x5a, 0x54, 0x12, 0x9a, 0x59,
      0x5a, 0x54, 0xf1, 0xc4, 0x7d, 0x4c, 0x03, 0xc5, 0x9e, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x06, 0x00, 0x00, 0x00, 0x01, 0x11, 0x9a, 0x59, 0x5a, 0x54, 0x12, 0x9a, 0x59, 0x5a, 0x54, 0xf1,
      0xc4, 0x7d, 0x4c, 0x03, 0xc5, 0x9e, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
      0x00, 0x01, 0x11, 0x9a, 0x59, 0x5a, 0x54, 0x12, 0x9a, 0x59, 0x5a, 0x54, 0xf1, 0xc4, 0x7d, 0x4c,
      0x03, 0xc5, 0x9e, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x11,
      0x9a, 0x59, 0x5a, 0x54, 0x12, 0x9a, 0x59, 0x5a, 0x54, 0xf1, 0xc4, 0x7d, 0x4c, 0x03, 0xc5, 0x9e,
      0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51
    ).map(_.toByte))

    expect(Array(
      0x7e, 0x41, 0x04, 0x2a
    ).map(_.toByte))

    send(Array(
      0x7e, 0x41, 0x02, 0x09, 0x00, 0x00, 0x00, 0x01, 0x11, 0xc4, 0x59, 0x5a, 0x54, 0x11, 0xc4, 0x59,
      0x5a, 0x54, 0xf0, 0x4c, 0x7c, 0x4c, 0x4c, 0x31, 0x9e, 0x71, 0x00, 0x00, 0xe0, 0x40, 0x02, 0x00,
      0x0a, 0x00, 0x00, 0x00, 0x01, 0x11, 0xc4, 0x59, 0x5a, 0x54, 0x11, 0xc4, 0x59, 0x5a, 0x54, 0xf0,
      0x4c, 0x7c, 0x4c, 0x4c, 0x31, 0x9e, 0x71, 0x00, 0x00, 0xe0, 0x40, 0x02, 0x00, 0xcd
    ).map(_.toByte))

    expect(Array(
      0x7e, 0x41, 0x02, 0x8c
    ).map(_.toByte))

    socket.close()

  }


  @Test
  def testA5(): Unit ={

    //    -------Сервер NTCB запущен-------

    //    12:19:39:867 Подключение устройства 100000000000001
    //
    //    12:19:39:867 принято от устройства 100000000000001 : 35 байт
    //      0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x4d, 0x46,
    //    0x2a, 0x3e, 0x53, 0x3a, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
    //    0x30, 0x30, 0x31,

    send(Array(0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x4d, 0x46,
      0x2a, 0x3e, 0x53, 0x3a, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
      0x30, 0x30, 0x31).map(_.toByte))

    //    12:19:39:882 отправлено устройству 100000000000001 : 19 байт
    //      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x45, 0x5e,
    //    0x2a, 0x3c, 0x53,

    expect(Array(0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0x00, 0x45, 0x5e,
      0x2a, 0x3c, 0x53).map(_.toByte))


    //    12:19:39:914 принято от устройства 100000000000001 : 35 байт
    //      0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0xfb, 0xf0,
    //    0x2a, 0x3e, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a, 0x45, 0xe1, 0xec, 0x00, 0x00, 0x00, 0x00,
    //    0x00, 0x00, 0x00,
    send(Array(0x40, 0x4e, 0x54, 0x43, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0xfb, 0xf0,
      0x2a, 0x3e, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a, 0x45, 0xe1, 0xec, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00).map(_.toByte))
    //    Заголовок:
    //      Pre = @NTC; IDobj = 0; IDdc = 1; Size = 19; Csd = 251; Csp = 240
    //    Protocol = 176; ProtocolVer = 10; StructVer = 10; DataSize = 69; Bitfield = 111000011110110000000000000000000000000000000000000000000000000000000000
    //
    //
    //    12:19:39:929 отправлено устройству 100000000000001 : 25 байт
    //      0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x09, 0x00, 0xb1, 0xa0,
    //    0x2a, 0x3c, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a,

    expect(Array(0x40, 0x4e, 0x54, 0x43, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x09, 0x00, 0xb1, 0xa0,
      0x2a, 0x3c, 0x46, 0x4c, 0x45, 0x58, 0xb0, 0x0a, 0x0a).map(_.toByte))


    //    12:19:59:757 принято от устройства 100000000000001 : 149 байт
    //      0x7e, 0x41, 0x05, 0x05, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb,
    //    0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    //    0x06, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d,
    //    0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
    //    0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b,
    //    0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x11,
    //    0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2,
    //    0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b,
    //    0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00,
    //    0x00, 0x00, 0x00, 0x00, 0x8b,

    send(Array( 0x7e, 0x41, 0x05, 0x05, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb,
      0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x06, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d,
      0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
      0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b,
      0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x01, 0x11,
      0xcf, 0xbb, 0x5b, 0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2,
      0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0x11, 0xcf, 0xbb, 0x5b,
      0x54, 0x01, 0xcf, 0xbb, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x8b).map(_.toByte))

    //
    //    ~A 5
    //    NumPage = 5; Code = 4353; Time = 1415297999; StateNGauge = 1; LastTime = 1415297999; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 6; Code = 4353; Time = 1415297999; StateNGauge = 1; LastTime = 1415297999; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 7; Code = 4353; Time = 1415297999; StateNGauge = 1; LastTime = 1415297999; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 8; Code = 4353; Time = 1415297999; StateNGauge = 1; LastTime = 1415297999; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 9; Code = 4353; Time = 1415297999; StateNGauge = 1; LastTime = 1415297999; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //
    //
    //    12:19:59:804 отправлено устройству 100000000000001 : 4 байт
    //      0x7e, 0x41, 0x05, 0x1b,

    expect(Array(0x7e, 0x41, 0x05, 0x1b).map(_.toByte))

    //    12:34:58:626 принято от устройства 100000000000001 : 207 байт
    //      0x7e, 0x41, 0x07, 0x0a, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf,
    //    0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    //    0x0b, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d,
    //    0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00,
    //    0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b,
    //    0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x01, 0x11,
    //    0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2,
    //    0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b,
    //    0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00,
    //    0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52,
    //    0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
    //    0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54,
    //    0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e,

    send(Array(0x7e, 0x41, 0x07, 0x0a, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf,
      0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x0b, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d,
      0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00,
      0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b,
      0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x01, 0x11,
      0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2,
      0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b,
      0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52,
      0xbf, 0x5b, 0x54, 0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x10, 0x00, 0x00, 0x00, 0x01, 0x11, 0x52, 0xbf, 0x5b, 0x54, 0x01, 0x52, 0xbf, 0x5b, 0x54,
      0x3d, 0xaa, 0xd0, 0x4b, 0xdf, 0xb7, 0xb2, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e).map(_.toByte))

    //    ~A 7
    //    NumPage = 10; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 11; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 12; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 13; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 14; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 15; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //    NumPage = 16; Code = 4353; Time = 1415298898; StateNGauge = 1; LastTime = 1415298898; Lat = 1271966269; Lon = 1890760671; Speed = 0; Course = 0;
    //
    //
    //    12:34:58:705 отправлено устройству 100000000000001 : 4 байт
    //      0x7e, 0x41, 0x07, 0x79,
    expect(Array(0x7e, 0x41, 0x07, 0x79).map(_.toByte))

  }


  @Test
  def commandTest(): Unit ={

    val commandMessage = "*>PASS:21s21"

    send("40 4e 54 43 00 00 00 00 50 31 27 03 13 00 4c 03 2a 3e 53 3a 38 36 38 32 30 34 30 30 34 32 31 31 32 36 33")
    expect("40 4e 54 43 50 31 27 03 00 00 00 00 03 00 45 1a 2a 3c 53 ")
    ServerTest.server.sendCommand("868204004211263",
      new PasswordCommand("21s21")
    )
    expect("40 4e 54 43 50 31 27 03 00 00 00 00 0c 00 4c 1c 2a 3e 50 41 53 53 3a 32 31 73 32 31")

    ServerTest.server.sendCommand("868204004211263", new IOSwitchCommand(2, true))

    send("40 4e 54 43 00 00 00 00 50 31 27 03 06 00 1a 40 2a 21 50 41 53 53")
    expect("40 4e 54 43 50 31 27 03 00 00 00 00 04 00 60 38 2a 21 32 59")
    send("40 4e 54 43 00 00 00 00 50 31 27 03 27 00 5c 27 2a 40 43 80 10 00 00 20 a1 ee f2 64 54 26 61 fe 01 7c c9 59 01 33 06 00 00 00 f2 64 54 0e 43 ee 00 00 00 1b 00 7b 29 ")
    expect("40 4e 54 43 50 31 27 03 00 00 00 00 03 00 84 db 7e 43 b9")

    Assert.assertTrue("server must have complete all commands ", ServerTest.server.hasNoCommands)

  }

  @Test
  def test37(): Unit ={

    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 4c 47 2a 3e 53 3a 38 36 38 32 30 34 30 30 38 37 33 30 34 30 39")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 03 00 45 5e 2a 3c 53")
    send("40 4e 54 43 01 00 00 00 00 00 00 00 b4 02 7b d5 " +
      "2a 3e 41 08 25 d8 08 00 00 06 a2 0d 39 21 09 0b " +
      "0e 08 2b 0e 34 88 a1 2f b9 2e 15 00 02 00 00 00 " +
      " 00 00 00 00 00 00 0f 0d 39 21 09 0b 0e 35 95 78 " +
      " 3f 2e 45 27 3f 00 00 00 00 5b 00 63 2c 40 3b 00 " +
      " 00 00 00 4b 00 4b 00 00 00 00 00 00 00 00 00 00 " +
      " 00 00 00 00 00 00 80 80 80 80 25 d9 08 00 00 00 " +
      " 15 0d 39 21 09 0b 0e 08 02 63 00 00 b2 2f cb 2e " +
      " 16 00 02 00 00 00 00 00 00 00 00 00 0c 0d 39 21 " +
      " 09 0b 0e 35 95 78 3f 2e 45 27 3f 00 00 00 00 5b " +
      " 00 63 2c 40 3b 00 00 00 00 00 00 00 00 00 00 00 " +
      " 00 00 00 00 00 00 00 00 00 00 00 00 80 80 80 80 " +
      " 25 da 08 00 00 02 a0 0d 39 22 09 0b 0e 08 02 63 " +
      " 00 08 b2 2f cb 2e 16 00 02 00 00 00 00 00 00 00 " +
      " 00 00 0c 0d 39 21 09 0b 0e 35 95 78 3f 2e 45 27 " +
      " 3f 00 00 00 00 5b 00 63 2c 40 3b 00 00 00 00 00 " +
      " 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      " 00 00 80 80 80 80 25 db 08 00 00 01 17 0d 39 23 " +
      " 09 0b 0e 08 02 63 00 08 b2 2f cb 2e 16 00 02 00 " +
      " 00 00 00 00 00 00 00 00 0d 0d 39 21 09 0b 0e 35 " +
      " 95 78 3f 2e 45 27 3f 00 00 00 00 5b 00 63 2c 40 " +
      " 3b 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      " 00 00 00 00 00 00 00 00 80 80 80 80 25 dc 08 00 " +
      " 00 02 18 0d 39 2b 09 0b 0e 08 02 63 00 08 a9 2f " +
      " c2 2e 16 00 02 00 00 00 00 00 00 00 00 00 0d 0d " +
      " 39 21 09 0b 0e 35 95 78 3f 2e 45 27 3f 00 00 00 " +
      " 00 5b 00 63 2c 40 3b 00 00 00 00 07 00 00 00 00 " +
      " 00 00 00 00 00 00 00 00 00 00 00 00 00 00 80 80 " +
      " 80 80 25 dd 08 00 00 03 17 0d 39 36 09 0b 0e 08 " +
      " 0a 63 18 08 a9 2f c2 2e 16 00 02 00 00 00 00 00 " +
      " 00 00 00 00 0f 0d 39 36 09 0b 0e 1e 95 78 3f b6" +
      " 44 27 3f 00 00 00 00 5b 00 63 2c 40 3b 00 00 00 " +
      " 00 02 00 01 00 00 00 00 00 00 00 00 00 00 00 00 " +
      " 00 00 00 00 80 80 80 80 25 de 08 00 00 01 18 0d " +
      " 3a 05 09 0b 0e 08 0b 63 2c 08 ac 2f c0 2e 16 00 " +
      " 02 00 00 00 00 00 00 00 00 00 0f 0d 3a 05 09 0b " +
      " 0e 0b 95 78 3f 1d 45 27 3f 00 00 00 00 5b 00 63 " +
      " 2c 40 3b 00 00 00 00 0b 00 0b 00 00 00 00 00 00 " +
      " 00 00 00 00 00 00 00 00 00 00 80 80 80 80 25 df " +
      " 08 00 00 03 18 0d 3a 29 09 0b 0e 08 2b 0d 30 08 " +
      " a5 2f bd 2e 16 00 02 00 00 00 00 00 00 00 00 00 " +
      " 0f 0d 3a 28 09 0b 0e 13 95 78 3f 3a 45 27 3f 00 " +
      " 00 00 00 5b 00 63 2c 40 3b 00 00 00 00 23 00 23 " +
      " 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 " +
      " 80 80 80 80                                     ")

    expect("40 4e 54 43 00 00 00 00 01 00 00 00 04 00 5f 43 2a 3c 41 08")



  }

  @Test
  def flexNull(): Unit = {

    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 4a 41 2a 3e 53 3a 38 36 33 35 39 31 30 32 39 33 35 31 34 38 37")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 03 00 45 5e 2a 3c 53")
    send("40 4e 54 43 01 00 00 00 00 00 00 00 13 00 f6 fd 2a 3e 46 4c 45 58 b0 0a 0a 45 00 00 00 00 00 00 00 00 00")
    expect("40 4e 54 43 00 00 00 00 01 00 00 00 09 00 b1 a0 2a 3c 46 4c 45 58 b0 0a 0a")
    send("7e 41 03 bd")
    expect("7e 41 03 bd ")
    send("7e 41 06 48")
    expect("7e 41 06 48")
    send("7e 54 c8 7b 00 00 a3")
    expect("7e 54 c8 7b 00 00 a3")
    send("7f")
    send("7f")
    send("7e 41 01 df")
    expect("7e 41 01 df")

  }


}

object ServerTest extends grizzled.slf4j.Logging {

  val NAV_TEST_PORT = ru.sosgps.wayrecall.testutils.getFreePort

  var server: NavTelecomNettyServer = null

  @BeforeClass
  def initserver() {
    server = new NavTelecomNettyServer
    //server.timer = new HashedWheelTimer()
    server.setStore(new DummyPackSaver)
    //server.commands = commands
    server.bossPool = new NioEventLoopGroup()
    server.workerPool = server.bossPool


    server.setPort(NAV_TEST_PORT)
    server.start()
  }

}


